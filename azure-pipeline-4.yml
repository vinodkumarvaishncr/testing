trigger: none

pool:
  vmImage: ubuntu-latest

variables:
  svc: 'my-webapp-connect'
  config-path: '$(System.DefaultWorkingDirectory)/driver'

parameters:
  - name: init
    type: boolean
    default: false

  - name: validate
    type: boolean
    default: false

  - name: plan
    type: boolean
    default: false

  - name: apply
    type: boolean
    default: false

  - name: environment
    type: string
    default: preprod
    values:
      - dev
      - preprod
      - prod

# '${parameters.environment}}.tfstate' = 'preprod.tfstate'
# -var-file=../resource_group/dev.tfvars
# terraform plan -var-file=dev.tfvars

# '${}' -- variable
# $(config-path)/${{parameters.environment}}.tfvars

steps:
# task 1: terraform ko install marenge
- task: TerraformInstaller@1
  displayName: 'Terraform tool ko install kar rahe hain'
  inputs:
    terraformVersion: 'latest'

# task 2: terraform init
- task: TerraformTaskV5
  displayName: 'Terraform init kar do'
  inputs:
    provider: 'azurerm'
    command: 'init'
    workingDirectory: '$(System.DefaultWorkingDirectory)/driver'
    backendServiceArm: '$(svc)'
    backendAzureRmStorageAccountName: 'achintastg007'
    backendAzureRmContainerName: 'my-terra'
    backendAzureRmKey: '${{parameters.environment}}.tfstate'

# task 3: terraform validate
- task: TerraformTaskV5
  displayName: 'Terraform project ko validate ka rahe hain'
  condition: '${{parameters.validate}}'
  inputs:
    provider: 'azurerm'
    command: 'validate'
    workingDirectory: '$(config-path)'

# task 4: terraform plan
- task: TerraformTaskV5
  displayName: 'Terraform plan ho raha h'
  condition: '${{parameters.plan}}'
  inputs:
    provider: 'azurerm'
    command: 'plan'
    workingDirectory: '$(config-path)'
    commandOptions: '-var-file=$(config-path)/${{parameters.environment}}.tfvars'
    environmentServiceNameAzureRM: '$(svc)'

# task 5: terraform apply
- task: TerraformTaskV5
  displayName: 'Terraform ko apply mar dia'
  condition: '${{parameters.apply}}'
  inputs:
    provider: 'azurerm'
    command: 'apply'
    workingDirectory: '$(config-path)'
    commandOptions: '-var-file=$(config-path)/${{parameters.environment}}.tfvars'
    environmentServiceNameAzureRM: '$(svc)'
